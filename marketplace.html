<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äºŒæ‰‹å•†å“è¯¦æƒ… - ä¸œç€›æ¸¸ä¾ </title>
    <meta name="description" content="ä¸œç€›æ¸¸ä¾ ä¾ å®¢å¸‚é›† - åœ¨æ—¥åäººäºŒæ‰‹äº¤æ˜“å¹³å°">
    <!-- PWA & å›¾æ ‡ -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#006633">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="apple-touch-icon.png">
    <!-- æ ·å¼ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <style>
        .loading-spinner { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .gradient-marketplace { background: linear-gradient(135deg, #EC4899 0%, #F43F5E 50%, #EF4444 100%); }
        .image-gallery img { cursor: pointer; transition: all 0.2s; }
        .image-gallery img:hover { opacity: 0.8; }
        .status-available { background: linear-gradient(135deg, #10B981, #059669); }
        .status-sold { background: linear-gradient(135deg, #6B7280, #4B5563); }
        .status-reserved { background: linear-gradient(135deg, #F59E0B, #D97706); }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="fixed w-full bg-white/95 backdrop-blur-md shadow-sm z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <span class="text-lg font-bold text-gray-800">ğŸ¯ ä¸œç€›æ¸¸ä¾ </span>
            </a>
            <a href="index.html#contact" class="bg-pink-500 text-white px-4 py-2 rounded-full text-sm hover:bg-pink-600 transition">
                ä¸‹è½½APP
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="pt-16 pb-24">
        <!-- åŠ è½½çŠ¶æ€ -->
        <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh]">
            <div class="w-12 h-12 border-4 border-pink-500 border-t-transparent rounded-full loading-spinner"></div>
            <p class="mt-4 text-gray-500">æ­£åœ¨åŠ è½½å•†å“ä¿¡æ¯...</p>
        </div>

        <!-- é”™è¯¯çŠ¶æ€ -->
        <div id="error" class="hidden flex flex-col items-center justify-center min-h-[60vh] px-4">
            <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mb-4">
                <i class="fas fa-exclamation-triangle text-red-500 text-3xl"></i>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mb-2">å•†å“ä¸å­˜åœ¨</h2>
            <p class="text-gray-500 mb-6 text-center">è¯¥å•†å“å¯èƒ½å·²åˆ é™¤æˆ–é“¾æ¥æ— æ•ˆ</p>
            <a href="index.html" class="bg-pink-500 text-white px-6 py-2 rounded-full hover:bg-pink-600 transition">
                è¿”å›é¦–é¡µ
            </a>
        </div>

        <!-- å•†å“å†…å®¹ -->
        <div id="content" class="hidden fade-in">
            <div class="container mx-auto px-4 py-6">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- å·¦ä¾§ï¼šå›¾ç‰‡åŒºåŸŸ -->
                    <div>
                        <!-- ä¸»å›¾ -->
                        <div class="relative bg-white rounded-2xl overflow-hidden shadow-sm mb-4">
                            <img id="mainImage" src="" alt="å•†å“å›¾ç‰‡"
                                 class="w-full aspect-square object-contain bg-gray-50">
                            <!-- çŠ¶æ€æ ‡ç­¾ -->
                            <div id="statusBadge" class="absolute top-4 right-4 px-4 py-2 rounded-full text-white font-bold text-sm shadow-lg">
                            </div>
                        </div>
                        <!-- ç¼©ç•¥å›¾ -->
                        <div id="thumbnails" class="image-gallery grid grid-cols-5 gap-2">
                            <!-- ç¼©ç•¥å›¾å°†åŠ¨æ€æ’å…¥ -->
                        </div>
                    </div>

                    <!-- å³ä¾§ï¼šå•†å“ä¿¡æ¯ -->
                    <div>
                        <!-- å•†å“æ ‡é¢˜ -->
                        <h1 id="itemTitle" class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4"></h1>

                        <!-- ä»·æ ¼åŒºåŸŸ -->
                        <div class="bg-gradient-to-r from-pink-50 to-red-50 rounded-xl p-4 mb-6">
                            <div class="flex items-baseline gap-2">
                                <span class="text-3xl sm:text-4xl font-bold text-pink-500" id="itemPrice"></span>
                            </div>
                            <div class="flex items-center gap-4 mt-2 text-sm text-gray-500">
                                <span id="viewCount"><i class="fas fa-eye mr-1"></i></span>
                                <span id="likeCount"><i class="fas fa-heart mr-1"></i></span>
                                <span id="postTime"><i class="fas fa-clock mr-1"></i></span>
                            </div>
                        </div>

                        <!-- å•†å“å±æ€§ -->
                        <div class="space-y-4 mb-6">
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">æˆè‰²</span>
                                <span id="itemCondition" class="text-gray-800 font-medium"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">åˆ†ç±»</span>
                                <span id="itemCategory" class="text-gray-800"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">äº¤æ˜“æ–¹å¼</span>
                                <span id="itemDelivery" class="text-gray-800"></span>
                            </div>
                            <div class="flex items-center">
                                <span class="text-gray-500 w-20">ä½ç½®</span>
                                <span id="itemLocation" class="text-gray-800"></span>
                            </div>
                        </div>

                        <!-- å–å®¶ä¿¡æ¯ -->
                        <div class="bg-white rounded-xl p-4 border border-gray-100 mb-6">
                            <div class="flex items-center gap-3">
                                <img id="sellerAvatar" src="" alt="å–å®¶å¤´åƒ"
                                     class="w-12 h-12 rounded-full object-cover border-2 border-gray-100">
                                <div class="flex-1">
                                    <h4 id="sellerName" class="font-medium text-gray-800"></h4>
                                    <p id="sellerInfo" class="text-gray-500 text-sm"></p>
                                </div>
                                <a href="" id="sellerLink" class="text-pink-500 text-sm hover:text-pink-600">
                                    æŸ¥çœ‹ä¸»é¡µ <i class="fas fa-chevron-right ml-1"></i>
                                </a>
                            </div>
                        </div>

                        <!-- ä¸‹è½½APPæç¤º -->
                        <div class="bg-gradient-to-br from-pink-500 to-rose-600 rounded-xl p-6 text-white">
                            <div class="text-center">
                                <div class="w-14 h-14 bg-white/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <i class="fas fa-comments text-2xl"></i>
                                </div>
                                <h3 class="font-bold text-lg mb-2">è”ç³»å–å®¶è´­ä¹°</h3>
                                <p class="text-white/80 text-sm mb-4">ä¸‹è½½APPä¸å–å®¶ç§èŠï¼Œäº«å—å¹³å°æ‹…ä¿äº¤æ˜“</p>
                                <a href="https://pub-3e154ce6d5c8487f833628106145e7a2.r2.dev/dongyingyouxia_v1.4.5_test.apk" download
                                   class="block bg-white text-pink-600 py-3 rounded-xl font-bold hover:bg-pink-50 transition">
                                    <i class="fab fa-android mr-2"></i> ä¸‹è½½APPè´­ä¹°
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å•†å“è¯¦æƒ… -->
                <div class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-info-circle text-pink-500 mr-2"></i>
                        å•†å“è¯¦æƒ…
                    </h2>
                    <div id="itemDescription" class="bg-white rounded-xl p-6 shadow-sm">
                        <!-- å•†å“æè¿°å°†åŠ¨æ€æ’å…¥ -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨å›ºå®šæ  -->
    <div id="bottomBar" class="hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 px-4 py-3 z-40">
        <div class="container mx-auto flex items-center justify-between gap-4">
            <div class="flex-shrink-0">
                <p class="text-gray-500 text-xs">äºŒæ‰‹ä»·æ ¼</p>
                <p class="text-pink-500 font-bold text-xl" id="bottomPrice"></p>
            </div>
            <a href="https://pub-3e154ce6d5c8487f833628106145e7a2.r2.dev/dongyingyouxia_v1.4.5_test.apk" download
               class="flex-1 bg-gradient-to-r from-pink-500 to-rose-600 text-white text-center py-3 rounded-xl font-bold hover:opacity-90 transition">
                <i class="fab fa-android mr-2"></i> ä¸‹è½½APPè´­ä¹°
            </a>
        </div>
    </div>

    <!-- é¡µè„š -->
    <footer class="bg-gray-900 text-white py-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-gray-400 text-sm mb-2">ä¸œç€›æ¸¸ä¾  - åœ¨æ—¥åäººçš„ç”Ÿæ´»æœåŠ¡å¹³å°</p>
            <p class="text-gray-500 text-xs">&copy; 2026 æ ªå¼ä¼šç¤¾æ˜‡é™½å•†äº‹</p>
        </div>
    </footer>

    <!-- APIé…ç½® -->
    <script src="api-config.js"></script>
    <script>
        let currentImageIndex = 0;
        let itemImages = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const itemId = getUrlParam('id');

            if (!itemId) {
                showError();
                return;
            }

            try {
                const item = await getMarketplaceItemById(itemId);

                if (!item) {
                    showError();
                    return;
                }

                renderItem(item);

            } catch (err) {
                console.error('åŠ è½½å•†å“å¤±è´¥:', err);
                showError();
            }
        });

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }

        function renderItem(item) {
            // æ›´æ–°é¡µé¢æ ‡é¢˜
            document.title = `${item.title} - ä¾ å®¢å¸‚é›†`;

            // å¤„ç†å›¾ç‰‡
            itemImages = [];
            if (item.images && item.images.length > 0) {
                itemImages = item.images;
            } else {
                itemImages = [DEFAULT_PRODUCT_IMAGE];
            }

            // ä¸»å›¾
            document.getElementById('mainImage').src = itemImages[0];

            // ç¼©ç•¥å›¾
            const thumbnails = document.getElementById('thumbnails');
            if (itemImages.length > 1) {
                thumbnails.innerHTML = itemImages.map((img, index) => `
                    <img src="${img}" alt="ç¼©ç•¥å›¾${index + 1}"
                         class="aspect-square object-cover rounded-lg border-2 ${index === 0 ? 'border-pink-500' : 'border-transparent'}"
                         onclick="switchImage(${index})"
                         onerror="this.src='${DEFAULT_PRODUCT_IMAGE}'">
                `).join('');
            }

            // çŠ¶æ€æ ‡ç­¾
            const statusBadge = document.getElementById('statusBadge');
            const statusMap = {
                'available': { text: 'åœ¨å”®ä¸­', class: 'status-available' },
                'sold': { text: 'å·²å”®å‡º', class: 'status-sold' },
                'reserved': { text: 'å·²é¢„å®š', class: 'status-reserved' }
            };
            const status = statusMap[item.status] || statusMap['available'];
            statusBadge.textContent = status.text;
            statusBadge.classList.add(status.class);

            // å•†å“ä¿¡æ¯
            document.getElementById('itemTitle').textContent = item.title;
            document.getElementById('itemPrice').textContent = formatPrice(item.price);
            document.getElementById('bottomPrice').textContent = formatPrice(item.price);

            // æµè§ˆé‡ã€ç‚¹èµã€å‘å¸ƒæ—¶é—´
            document.getElementById('viewCount').innerHTML = `<i class="fas fa-eye mr-1"></i>${item.view_count || 0} æµè§ˆ`;
            document.getElementById('likeCount').innerHTML = `<i class="fas fa-heart mr-1"></i>${item.like_count || 0} å–œæ¬¢`;
            document.getElementById('postTime').innerHTML = `<i class="fas fa-clock mr-1"></i>${formatDate(item.created_at)}`;

            // å•†å“å±æ€§
            document.getElementById('itemCondition').textContent = getConditionName(item.condition);
            document.getElementById('itemCategory').textContent = getCategoryName(item.category);
            document.getElementById('itemDelivery').textContent = getDeliveryName(item.delivery_method);
            document.getElementById('itemLocation').textContent = item.location || 'æœªæŒ‡å®š';

            // å–å®¶ä¿¡æ¯
            if (item.users) {
                const user = item.users;
                document.getElementById('sellerAvatar').src = user.avatar_url || DEFAULT_AVATAR;
                document.getElementById('sellerName').textContent = user.nickname || 'å–å®¶';
                document.getElementById('sellerInfo').textContent = `å‘å¸ƒäº† ${item.user_item_count || 1} ä»¶å•†å“`;
                document.getElementById('sellerLink').href = `seller.html?id=${user.id}`;
            }

            // å•†å“æè¿°
            const descriptionEl = document.getElementById('itemDescription');
            if (item.description) {
                descriptionEl.innerHTML = `<p class="text-gray-700 whitespace-pre-wrap">${item.description}</p>`;
            } else {
                descriptionEl.innerHTML = '<p class="text-gray-400">æš‚æ— è¯¦ç»†æè¿°</p>';
            }

            // æ˜¾ç¤ºå†…å®¹
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
            document.getElementById('bottomBar').classList.remove('hidden');
        }

        function switchImage(index) {
            currentImageIndex = index;
            document.getElementById('mainImage').src = itemImages[index];

            const thumbs = document.querySelectorAll('#thumbnails img');
            thumbs.forEach((thumb, i) => {
                if (i === index) {
                    thumb.classList.remove('border-transparent');
                    thumb.classList.add('border-pink-500');
                } else {
                    thumb.classList.remove('border-pink-500');
                    thumb.classList.add('border-transparent');
                }
            });
        }

        function getConditionName(condition) {
            const conditions = {
                'new': 'å…¨æ–°',
                'like_new': 'å‡ ä¹å…¨æ–°',
                'good': 'æˆè‰²è‰¯å¥½',
                'fair': 'æœ‰ä½¿ç”¨ç—•è¿¹',
                'poor': 'åŠŸèƒ½æ­£å¸¸'
            };
            return conditions[condition] || condition || 'æœªæ ‡æ³¨';
        }

        function getCategoryName(category) {
            const categories = {
                'electronics': 'æ•°ç ç”µå™¨',
                'fashion': 'æœé¥°é‹åŒ…',
                'home': 'å®¶å±…ç”¨å“',
                'baby': 'æ¯å©´ç”¨å“',
                'sports': 'è¿åŠ¨æˆ·å¤–',
                'books': 'å›¾ä¹¦å½±éŸ³',
                'beauty': 'ç¾å¦†æŠ¤è‚¤',
                'food': 'é£Ÿå“é¥®æ–™',
                'car': 'æ±½è½¦ç”¨å“',
                'other': 'å…¶ä»–'
            };
            return categories[category] || category || 'å…¶ä»–';
        }

        function getDeliveryName(method) {
            const methods = {
                'face_to_face': 'å½“é¢äº¤æ˜“',
                'shipping': 'å¿«é€’é‚®å¯„',
                'both': 'æ”¯æŒå¿«é€’/è‡ªå–'
            };
            return methods[method] || method || 'å½“é¢äº¤æ˜“';
        }
    </script>
</body>

</html>
